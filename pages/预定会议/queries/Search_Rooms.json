{
  "pluginType": "DB",
  "pluginId": "mysql-plugin",
  "unpublishedAction": {
    "name": "Search_Rooms",
    "datasource": {
      "name": "会议室预约管理系统数据库",
      "pluginId": "mysql-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "会议室预约管理系统数据库",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "预定会议",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "SELECT \n  r.id, \n  r.name, \n  r.capacity, \n  r.description,\n\tf.name AS floor_name,        -- 查出楼层名 (如 HQ-3F)\n  b.name AS building_name,     -- 查出大楼名 (如 集团总部大厦)\n  CASE \n    WHEN EXISTS (\n      SELECT 1 FROM booking b \n      WHERE b.room_id = r.id \n        AND b.status_code IN (0, 1) -- 排除已取消的\n        -- 时间重叠判断\n        AND (b.start_time < {{ date_end.formattedDate }} AND b.end_time > {{ date_start.formattedDate }})\n    ) THEN 'Occupied' -- 已占用\n    ELSE 'Available'  -- 空闲\n  END AS availability\nFROM meeting_room r\nJOIN floor f ON r.floor_id = f.id\nJOIN building b ON f.building_id = b.id\nWHERE \n  -- 1. 状态必须可用\n  r.status = 1\n  -- 2. 容量筛选 (原有逻辑)\n  AND r.capacity >= {{ Number(select_capacity.selectedOptionValue || 0) }}\n  \n  -- 3. 【新增】位置筛选逻辑\n  AND (\n      -- 情况A: 用户没选任何位置 (数组长度为0)，则不限制，查所有\n      {{ tree_location.selectedOptionValues.length == 0 }}\n      OR\n      -- 情况B: 用户选了位置，用 IN 筛选 floor_id\n      -- JS 逻辑：过滤掉 \"BUILDING_\" 开头的父节点 ID，只保留纯数字的 floor_id\n      r.floor_id IN (\n          {{ \n             tree_location.selectedOptionValues\n                .filter(val => typeof val === 'number') \n                .join(',') \n          }}\n      )\n  )\nORDER BY \n  -- 第一优先级：按状态排序 (Available 在 Occupied 之前)\n  availability ASC,\n  \n  -- 第二优先级：按ID排序 (保证相同状态下，房间不乱跑)\n  r.id ASC;",
      "selfReferencingDataPaths": [],
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ]
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [
      " \n             tree_location.selectedOptionValues\n                .filter(val => typeof val === 'number') \n                .join(',') \n          ",
      " Number(select_capacity.selectedOptionValue || 0) ",
      " date_end.formattedDate ",
      " date_start.formattedDate ",
      " tree_location.selectedOptionValues.length == 0 "
    ],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "预定会议_Search_Rooms",
  "deleted": false,
  "gitSyncId": "692af5888fc1e0541ea208a0_69465af14f1d584d942c74be"
}